@page "/board"
@using Frontend.Models
@inject Services.BoardService BoardService

<h3>Boards</h3>

<button class="btn btn-primary mb-2" @onclick="LoadBoards">Load Boards</button>
<button class="btn btn-success mb-2" @onclick="ShowCreateForm">New Board</button>
<button class="btn btn-success mb-2" @onclick="ShowAddDeleteComponentForm">Add Component to Board</button>

@if (Boards == null)
{
    <p>Loading...</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Description</th>
                <th>Length</th>
                <th>Width</th>
                <th>Components</th>
                <th>Orders</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var board in Boards)
            {
                <tr>
                    <td>@board.Description</td>
                    <td>@board.Length</td>
                    <td>@board.Width</td>
                    <td>@string.Join(", ", board.ComponentIds)</td>
                    <td>@string.Join(", ", board.OrderIds)</td>
                    <td>
                        <button class="btn btn-warning btn-sm" @onclick="() => EditBoard(board)">Edit</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteBoard(board.Id)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ShowForm)
{
    <EditForm Model="SelectedBoard" OnValidSubmit="SaveBoard">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-2">
            <label>Description</label>
            <InputText class="form-control" @bind-Value="SelectedBoard.Description" />
        </div>

        <div class="mb-2">
            <label>Length</label>
            <InputNumber class="form-control" @bind-Value="SelectedBoard.Length" />
        </div>

        <div class="mb-2">
            <label>Width</label>
            <InputNumber class="form-control" @bind-Value="SelectedBoard.Width" />
        </div>

        <div class="mb-2">
            <label>Component IDs (comma separated)</label>
            <InputText class="form-control" @bind-Value="ComponentIdsInput" />
        </div>

        <div class="mb-2">
            <label>Order IDs (comma separated)</label>
            <InputText class="form-control" @bind-Value="OrderIdsInput" />
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
    </EditForm>
}

@if (ShowComponentForm)
{
    <div class="mb-2">
        <label>BoardId</label>
        <InputText class="form-control" @bind-Value="BoardId" />
    </div>

    <div class="mb-2">
        <label>ComponentId</label>
        <InputText class="form-control" @bind-Value="ComponentId" />
    </div>

    <button type="button" class="btn btn-primary" @onclick="AddComponent">Add</button>
    <button type="button" class="btn btn-primary" @onclick="DeleteComponent">Delete</button>
    <button type="button" class="btn btn-secondary" @onclick="CancelComponentForm">Cancel</button>
}

@code {
    private List<Board> Boards = new();
    private Board SelectedBoard = new();
    private bool ShowForm = false;
    private string ComponentIdsInput = "";
    private string OrderIdsInput = "";
    private string BoardId = "";
    private string ComponentId = "";
    private bool ShowComponentForm = false;


    private async Task LoadBoards()
    {
        Boards = await BoardService.GetBoardsAsync() ?? [];
    }

    private void ShowCreateForm()
    {
        SelectedBoard = new Board();
        ComponentIdsInput = "";
        OrderIdsInput = "";
        ShowForm = true;
    }

    private void ShowAddDeleteComponentForm()
    {
        ShowComponentForm = true;
    }

    private void CancelComponentForm()
    {
        ShowComponentForm = false;
    }

    private void EditBoard(Board board)
    {
        SelectedBoard = new Board
        {
            Id = board.Id,
            Description = board.Description,
            Length = board.Length,
            Width = board.Width,
            ComponentIds = board.ComponentIds.ToList(),
            OrderIds = board.OrderIds.ToList()
        };
        ComponentIdsInput = string.Join(",", SelectedBoard.ComponentIds);
        OrderIdsInput = string.Join(",", SelectedBoard.OrderIds);
        ShowForm = true;
    }

    private void CancelForm()
    {
        ShowForm = false;
    }

    private async Task SaveBoard()
    {
        SelectedBoard.ComponentIds = ComponentIdsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => Guid.Parse(s.Trim()))
            .ToList();

        SelectedBoard.OrderIds = OrderIdsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => Guid.Parse(s.Trim()))
            .ToList();

        if (SelectedBoard.Id == Guid.Empty)
        {
            SelectedBoard.Id = Guid.NewGuid();
            await BoardService.CreateBoardAsync(SelectedBoard);
        }
        else
        {
            Guid? boardId = SelectedBoard.Id;
            await BoardService.UpdateBoardAsync(boardId!.Value, SelectedBoard);
        }

        ShowForm = false;
        await LoadBoards();
    }

    private async Task DeleteBoard(Guid id)
    {
        await BoardService.DeleteBoardAsync(id);
        await LoadBoards();
    }

    private async Task AddComponent()
    {
        if (!string.IsNullOrEmpty(BoardId) && !string.IsNullOrEmpty(ComponentId))
        {
            var guidComponent = Guid.Parse(ComponentId);
            var guidBoard = Guid.Parse(BoardId);
            await BoardService.AddComponentToBoardAsync(guidBoard, guidComponent);
        }
    }

    private async Task DeleteComponent()
    {
        if (!string.IsNullOrEmpty(BoardId) && !string.IsNullOrEmpty(ComponentId))
        {
            var guidComponent = Guid.Parse(ComponentId);
            var guidBoard = Guid.Parse(BoardId);
            await BoardService.RemoveComponentFromBoardAsync(guidBoard, guidComponent);
        }
    }
}
