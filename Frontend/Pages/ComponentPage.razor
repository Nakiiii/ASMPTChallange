@page "/component"
@using Frontend.Models
@inject Services.ComponentService ComponentService

<h3>Components</h3>

<button class="btn btn-primary mb-2" @onclick="LoadComponents">Load Components</button>
<button class="btn btn-success mb-2" @onclick="ShowCreateForm">New Component</button>

@if (Components == null)
{
    <p>Loading...</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Boards</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var comp in Components)
            {
                <tr>
                    <td>@comp.Description</td>
                    <td>@comp.Quantity</td>
                    <td>
                        <button class="btn btn-warning btn-sm" @onclick="() => EditComponent(comp)">Edit</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteComponent(comp.Id.Value)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ShowForm)
{
    <EditForm Model="SelectedComponent" OnValidSubmit="SaveComponent">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-2">
            <label>Description</label>
            <InputText class="form-control" @bind-Value="SelectedComponent.Description" />
        </div>

        <div class="mb-2">
            <label>Quantity</label>
            <InputNumber class="form-control" @bind-Value="SelectedComponent.Quantity" />
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
    </EditForm>
}

@code {
    private List<Component> Components = new();
    private Component SelectedComponent = new();
    private bool ShowForm = false;
    private string BoardIdsInput = "";

    private async Task LoadComponents()
    {
        Components = await ComponentService.GetComponentsAsync() ?? [];
    }

    private void ShowCreateForm()
    {
        SelectedComponent = new Component();
        BoardIdsInput = "";
        ShowForm = true;
    }

    private void EditComponent(Component comp)
    {
        SelectedComponent = new Component
        {
            Id = comp.Id,
            Description = comp.Description,
            Quantity = comp.Quantity,
        };
        ShowForm = true;
    }

    private void CancelForm()
    {
        ShowForm = false;
    }

    private async Task SaveComponent()
    {
        if (SelectedComponent.Id == null)
        {
            SelectedComponent.Id = Guid.NewGuid();
            await ComponentService.CreateComponentAsync(SelectedComponent);
        }
        else
        {
            Guid? componentId = SelectedComponent.Id;
            await ComponentService.UpdateComponentAsync(componentId!.Value, SelectedComponent);
        }

        ShowForm = false;
        await LoadComponents();
    }

    private async Task DeleteComponent(Guid id)
    {
        await ComponentService.DeleteComponentAsync(id);
        await LoadComponents();
    }
}
