@page "/order"
@using Frontend.Models
@inject Services.OrderService OrderService

<h3>Orders</h3>

<button class="btn btn-primary mb-2" @onclick="LoadOrders">Load Orders</button>
<button class="btn btn-success mb-2" @onclick="ShowCreateForm">New Order</button>
<button class="btn btn-success mb-2" @onclick="ShowAddDeleteBoardForm">Add Board to Order</button>



@if (Orders == null)
{
    <p>Loading...</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Description</th>
                <th>Order Date</th>
                <th>Boards</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Orders)
            {
                <tr>
                    <td>@order.Description</td>
                    <td>@order.OrderDate.ToShortDateString()</td>
                    <td>@string.Join(", ", order.BoardIds)</td>
                    <td>
                        <button class="btn btn-warning btn-sm" @onclick="() => EditOrder(order)">Edit</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteOrder((order.Id!).Value)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ShowForm)
{
    <EditForm Model="SelectedOrder" OnValidSubmit="SaveOrder">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-2">
            <label>Description</label>
            <InputText class="form-control" @bind-Value="SelectedOrder.Description" />
        </div>

        <div class="mb-2">
            <label>Order Date</label>
            <InputDate class="form-control" @bind-Value="SelectedOrder.OrderDate" />
        </div>

        <div class="mb-2">
            <label>Boards (IDs, comma separated)</label>
            <InputText class="form-control" @bind-Value="BoardIdsInput" />
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
    </EditForm>
}

@if (ShowBoardForm)
{
        <div class="mb-2">
            <label>OrderId</label>
            <InputText class="form-control" @bind-Value="OrderId" />
        </div>

        <div class="mb-2">
            <label>BoardId</label>
            <InputText class="form-control" @bind-Value="BoardId" />
        </div>

        <button type="button" class="btn btn-primary" @onclick="AddBoard">Add</button>
        <button type="button" class="btn btn-primary" @onclick="DeleteBoard">Delete</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelBoardForm">Cancel</button>
}

@code {
    private List<Order> Orders = new();
    private Order SelectedOrder = new();
    private bool ShowForm = false;
    private string BoardIdsInput = "";
    private bool ShowBoardForm = false;
    private string OrderId = "";
    private string BoardId = "";

    private async Task LoadOrders()
    {
        Orders = await OrderService.GetOrdersAsync();
    }

    private void ShowCreateForm()
    {
        SelectedOrder = new Order { OrderDate = DateTime.Today };
        BoardIdsInput = "";
        ShowForm = true;
    }

    private void ShowAddDeleteBoardForm ()
    {
        ShowBoardForm = true;
    }

    private void EditOrder(Order order)
    {
        SelectedOrder = new Order
        {
            Id = order.Id,
            Description = order.Description,
            OrderDate = order.OrderDate,
            BoardIds = order.BoardIds.ToList()
        };
        BoardIdsInput = string.Join(",", SelectedOrder.BoardIds);
        ShowForm = true;
    }

    private void CancelForm()
    {
        ShowForm = false;
    }

    private void CancelBoardForm()
    {
        ShowBoardForm = false;
    }

    private async Task SaveOrder()
    {
        // Parse Board IDs
        SelectedOrder.BoardIds = BoardIdsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => Guid.Parse(s.Trim()))
            .ToList();

        if (SelectedOrder.Id == null)
        {
            SelectedOrder.Id = Guid.NewGuid();
            await OrderService.CreateOrderAsync(SelectedOrder);
        }
        else
        {
            Guid? orderId = SelectedOrder.Id;
            await OrderService.UpdateOrderAsync(orderId!.Value, SelectedOrder);
        }

        ShowForm = false;
        await LoadOrders();
    }

    private async Task DeleteOrder(Guid id)
    {
        await OrderService.DeleteOrderAsync(id);
        await LoadOrders();
    }

    private async Task AddBoard()
    {
        if (!string.IsNullOrEmpty(OrderId) && !string.IsNullOrEmpty(BoardId))
        {
            var guidOrder = Guid.Parse(OrderId);
            var guidBoard = Guid.Parse(BoardId);
            await OrderService.AddBoardToOrderAsync(guidOrder, guidBoard);
        }
    }

    private async Task DeleteBoard()
    {
        if (!string.IsNullOrEmpty(OrderId) && !string.IsNullOrEmpty(BoardId))
        {
            var guidOrder = Guid.Parse(OrderId);
            var guidBoard = Guid.Parse(BoardId);
            await OrderService.RemoveBoardFromOrderAsync(guidOrder, guidBoard);
        }
    }
}